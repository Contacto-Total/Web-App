<app-toolbar></app-toolbar>

<div class="container">
  <!-- Header -->
  <div class="header">
    <h1 class="page-title">Consulta Din√°mica</h1>
  </div>

  <div class="layout">
    <!-- Main Form -->
    <div class="main-card">
      <form [formGroup]="form" class="dynamic-form">
        <!-- Tramo Section -->
        <div class="form-field">
          <label class="form-label">Tramo</label>
          <select formControlName="tramo" class="form-select">
            <option value="3">Tramo 3</option>
            <option value="5">Tramo 5</option>
          </select>
        </div>

        <!-- Variables Section -->
        <h2 class="section-title">
          <span class="material-icons">tune</span>
          Variables
        </h2>

        <div class="chip-groups">
          <ng-container *ngFor="let g of chipGroups">
            <!-- ‚¨áÔ∏è wrapper con clase por grupo -->
            <div class="chip-group" [ngClass]="'chip-group--' + g.key">
              <h3 class="chip-group-title">{{ g.title }}</h3>

              <div class="chip-container">
                <button
                  *ngFor="let c of g.items"
                  type="button"
                  class="chip"
                  [class.active]="isActive(c.key)"
                (click)="toggleChip(c.key, c.affectsSelects !== false)"
                [attr.aria-pressed]="isActive(c.key)"
                [disabled]="isChipDisabled(c.key)"
                >
                {{ c.label }}
                </button>
              </div>
            </div>
          </ng-container>
        </div>


        <!-- Importe Extra -->
        <div *ngIf="selectedChips.has('LTD') || selectedChips.has('LTDE') || selectedChips.has('LTD_LTDE')" class="form-field">
          <label class="form-label">Sumar importe</label>
          <input type="number" min="0" step="1" class="form-input" formControlName="importeExtra" placeholder="0">
        </div>

        <!-- Condiciones Section -->
        <h2 class="section-title">
          <span class="material-icons">rule</span>
          Condiciones
        </h2>
        <div class="checkbox-group">
          <label class="checkbox-item">
            <div class="checkbox">
              <input type="checkbox" (change)="toggleCond($event,'PROMESAS_HOY')">
              <span class="checkmark"></span>
            </div>
            PROMESAS HOY
          </label>
          <label class="checkbox-item">
            <div class="checkbox">
              <input type="checkbox" (change)="toggleCond($event,'PROMESAS_MANANA')">
              <span class="checkmark"></span>
            </div>
            PROMESAS MA√ëANA
          </label>
          <label class="checkbox-item">
            <div class="checkbox">
              <input type="checkbox" (change)="toggleCond($event,'PROMESAS_MANANA2')">
              <span class="checkmark"></span>
            </div>
            PROMESAS HOY Y MA√ëANA
          </label>
          <label class="checkbox-item">
            <div class="checkbox">
              <input type="checkbox" (change)="toggleCond($event,'PROMESAS_ROTAS')">
              <span class="checkmark"></span>
            </div>
            PROMESAS ROTAS
          </label>
        </div>

        <!-- Restricciones Section -->
        <h2 class="section-title">
          <span class="material-icons">block</span>
          Restricciones
        </h2>
        <div class="checkbox-group">
          <label class="checkbox-item">
            <div class="checkbox">
              <input type="checkbox" formControlName="noContenido">
              <span class="checkmark"></span>
            </div>
            No Contenido
          </label>
          <label class="checkbox-item">
            <div class="checkbox">
              <input type="checkbox" formControlName="excluirPromesasPeriodoActual">
              <span class="checkmark"></span>
            </div>
            Excluir Promesas periodo actual
          </label>
          <label class="checkbox-item">
            <div class="checkbox">
              <input type="checkbox" formControlName="excluirCompromisos">
              <span class="checkmark"></span>
            </div>
            Excluir Compromisos
          </label>
          <label class="checkbox-item">
            <div class="checkbox">
              <input type="checkbox" formControlName="excluirBlacklist">
              <span class="checkmark"></span>
            </div>
            Excluir Blacklist
          </label>
        </div>

        <!-- Plantilla Section -->
        <h2 class="section-title">
          <span class="material-icons">description</span>
          Plantilla
        </h2>
        <div class="form-field">
          <label class="form-label">Nombre</label>
          <input type="text" class="form-input" formControlName="nombre" placeholder="Nombre del combo/plantilla">
        </div>

        <div class="form-field">
          <label class="form-label label-with-count">
            <span>Texto de SMS</span>
          </label>
          <textarea class="form-textarea" formControlName="plantillaTexto" placeholder="Escribe el mensaje y usa BOTONES"></textarea>
        </div>
      </form>

      <!-- Results Table -->
      <div *ngIf="rows().length" class="results-card">
        <h2 class="section-title">
          <span class="material-icons">table_chart</span>
          Resultado
        </h2>
        <div class="table-container">
          <table class="data-table" mat-table [dataSource]="rows()">
            <ng-container *ngFor="let c of cols()" [matColumnDef]="c">
              <th mat-header-cell *matHeaderCellDef>{{ c }}</th>
              <td mat-cell *matCellDef="let r">{{ r[c] }}</td>
            </ng-container>
            <tr mat-header-row *matHeaderRowDef="cols()"></tr>
            <tr mat-row *matRowDef="let row; columns: cols();"></tr>
          </table>
        </div>
      </div>
    </div>

    <!-- Sidebar -->
    <aside class="aside-card">
      <h3 class="preview-title">
        <span class="material-icons">preview</span>
        Previsualizaci√≥n
      </h3>

      <div class="preview-box">
        {{ previewText() || 'Tu SMS aparecer√° aqu√≠‚Ä¶' }}
      </div>

      <div class="character-meter">
        <div class="character-bar"
             [class.warning]="previewText().length > 120"
             [class.danger]="previewText().length > 160"
             [style.width.%]="Math.min((previewText().length / 160) * 100, 100)">
        </div>
      </div>
      <div class="character-count">
        {{ previewText().length }} / 160
      </div>




      <p class="hint">
        üí° Consejo: mant√©n el mensaje bajo 160 caracteres o usa variables cortas.
      </p>

      <div class="button-group">
        <button type="button" class="btn btn-primary" (click)="generarGuiado()">
          <span class="material-icons">send</span>
          Generar
        </button>
        <button type="button" class="btn btn-secondary" (click)="guardarCombo()">
          <span class="material-icons">save</span>
          Guardar
        </button>
        <button type="button" class="btn btn-danger" (click)="Cancel()">
          <span class="material-icons">cancel</span>
          Cancelar
        </button>
      </div>
    </aside>
  </div>
</div>
